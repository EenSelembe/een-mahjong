<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Slot Mahjong</title>
  <style>
    :root{
      --bg:#b22222;
      --panel:#2b2b2b;
      --card:#ffffff;
      --accent:#28a745;
      --accent-2:#ffc107;
      --text:#ffffff;
      --tile:70px;
      --gap:6px;
    }
    /* Responsive sizing untuk HP */
    @media (max-width:480px){
      :root{ --tile:64px; --gap:6px; }
    }
    @media (max-width:380px){
      :root{ --tile:56px; --gap:5px; }
    }

    *{box-sizing:border-box}
    body{
      margin:0; padding:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg); color:var(--text);
      display:flex; flex-direction:column; align-items:center; min-height:100vh;
    }
    header{ width:100%; max-width:560px; padding:12px 14px 0; }
    h1{ margin:8px 0 4px; font-size:22px; line-height:1.1; }
    .hud{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0 10px; }
    .pill{
      background:#00000055; border:1px solid #ffffff22; padding:6px 10px; border-radius:10px;
      font-size:14px; display:flex; align-items:center; gap:6px;
    }
    .pill b{font-weight:700}

    .panel{
      background:var(--panel); border-radius:12px; padding:10px; box-shadow:0 6px 16px #00000040; margin:8px 12px;
      width:calc(var(--tile)*5 + var(--gap)*4 + 20px); /* grid + padding panel */
      max-width:calc(100vw - 24px);
    }

    /* GRID 4x5 */
    #slot{
      display:grid;
      grid-template-columns:repeat(5, var(--tile));
      grid-template-rows:repeat(4, var(--tile));
      gap:var(--gap);
      justify-content:center; align-content:center;
    }
    #slot img{
      width:var(--tile); height:var(--tile); object-fit:contain;
      background:var(--card); border-radius:10px; box-shadow:inset 0 0 0 1px #00000015;
      transition:transform .12s ease, filter .12s ease, opacity .12s ease;
      will-change:transform, filter, opacity;
    }

    .controls{ display:flex; gap:10px; justify-content:center; margin-top:10px; }
    button{
      padding:10px 18px; font-size:16px; border:none; border-radius:10px; cursor:pointer;
      color:#fff; background:var(--accent); box-shadow:0 3px 0 #167b2c; transition:transform .05s ease;
      touch-action:manipulation;
    }
    button:active{ transform:translateY(1px) }
    button[disabled]{ opacity:.6; cursor:not-allowed; }

    .status{ text-align:center; margin-top:8px; font-size:14px; min-height:18px; opacity:.9; }

    /* Animasi SPIN (kolom) */
    .spinning{ animation: spinBlur .25s linear infinite; }
    @keyframes spinBlur{
      0%{ filter:blur(0px) brightness(1) }
      50%{ filter:blur(1.5px) brightness(1.05) }
      100%{ filter:blur(0px) brightness(1) }
    }

    /* Animasi pecah */
    .win-pop{ animation: pop .22s ease forwards; }
    @keyframes pop{
      0%{transform:scale(1)}
      50%{transform:scale(1.2)}
      100%{transform:scale(1)}
    }

    /* Hilang (pecah) */
    .explode{ animation: explode .28s ease forwards; }
    @keyframes explode{
      to{ opacity:0; transform:scale(.4) rotate(15deg); filter:blur(2px); }
    }

    /* Jatuh (cascade) */
    .drop{ animation: drop .22s ease forwards; }
    @keyframes drop{
      from{ transform:translateY(-22px); opacity:.8 }
      to{ transform:translateY(0); opacity:1 }
    }

    footer{ margin:8px 0 16px; font-size:12px; opacity:.8; }

    /* Badge kecil pada tile (WILD/SCATTER) */
    .badge{
      position:absolute; right:2px; top:2px; font-size:10px; font-weight:700;
      background:#000000b0; padding:1px 4px; border-radius:6px; color:#fff; pointer-events:none;
    }
    .tile-wrap{ position:relative; width:var(--tile); height:var(--tile); border-radius:10px; overflow:visible; }
  </style>
</head>
<body>
  <header>
    <h1>Slot Mahjong</h1>
    <div class="hud">
      <div class="pill" id="saldo">Saldo: <b>Rp 10.000</b></div>
      <div class="pill" id="bet">Bet: <b>Rp 100</b></div>
      <div class="pill" id="frees">Free Spins: <b>0</b></div>
    </div>
  </header>

  <main class="panel">
    <div id="slot"></div>
    <div class="controls">
      <button id="spinBtn">üé∞ SPIN</button>
    </div>
    <div class="status" id="status"></div>
  </main>

  <footer>Wild menggantikan simbol biasa (bukan scatter). Scatter 3+ memicu 8 Free Spins.</footer>

  <!-- ===========================================================
       LEGACY CODE (TIDAK DIHAPUS) ‚Äî DIBIARKAN DI SINI SEBAGAI REFERENSI
       =========================================================== -->
  <!--
  <style>
    body { margin:0; padding:0; font-family:sans-serif; background:#b22222; color:#fff; display:flex; flex-direction:column; align-items:center;}
    h1 { margin:10px; }
    #slot { display:grid; grid-template-columns:repeat(5,70px); grid-template-rows:repeat(4,70px); gap:5px; background:#2b2b2b; padding:10px; border-radius:10px; margin:10px 0;}
    #slot img { width:70px; height:70px; object-fit:contain; background:#fff; border-radius:8px; }
    #controls { display:flex; gap:10px; }
    button { padding:10px 20px; font-size:16px; border:none; border-radius:8px; cursor:pointer; }
    #spin { background:#28a745; color:#fff; }
    #stop { background:#dc3545; color:#fff; }
    #saldo { margin-top:10px; font-size:18px; background:#00000066; padding:8px 16px; border-radius:8px; }
  </style>
  <div id="controls">
    <button id="spin">üé∞ Spin</button>
    <button id="stop">‚èπ Stop</button>
  </div>
  <div id="saldo">Saldo: Rp. 10000</div>
  <script>
    const symbols = [
      "bamboo-1.png","bamboo-2.png","bamboo-3.png","bamboo-4.png","bamboo-5.png",
      "bamboo-6.png","bamboo-7.png","bamboo-8.png","bamboo-9.png",
      "characters-1.png","characters-2.png","characters-3.png","characters-4.png","characters-5.png",
      "characters-6.png","characters-7.png","characters-8.png","characters-9.png",
      "dots-1.png","dots-2.png","dots-3.png","dots-4.png","dots-5.png",
      "dots-6.png","dots-7.png","dots-8.png","dots-9.png",
      "wind-east.png","wind-south.png","wind-west.png","wind-north.png",
      "dragon-red.png","dragon-green.png","dragon-white.png",
      "wild.png","scatter.png"
    ];
    const slot = document.getElementById("slot");
    const spinBtn = document.getElementById("spin");
    const stopBtn = document.getElementById("stop");
    const saldoBox = document.getElementById("saldo");
    let saldo = 10000;
    let spinning;
    function initGrid(){
      slot.innerHTML="";
      for(let i=0;i<20;i++){
        const img=document.createElement("img");
        img.src="img/tiles/"+symbols[Math.floor(Math.random()*symbols.length)];
        slot.appendChild(img);
      }
    }
    function startSpin(){
      if(saldo<100){ alert("Saldo tidak cukup!"); return; }
      saldo -= 100;
      saldoBox.innerText="Saldo: Rp. "+saldo;
      spinning = setInterval(()=>{
        const imgs = slot.querySelectorAll("img");
        imgs.forEach(img=>{
          img.src="img/tiles/"+symbols[Math.floor(Math.random()*symbols.length)];
        });
      },100);
    }
    function stopSpin(){ clearInterval(spinning); }
    spinBtn.addEventListener("click", startSpin);
    stopBtn.addEventListener("click", stopSpin);
    initGrid();
  </script>
  -->

  <script>
    /**************
     * KONFIGURASI
     **************/
    const BET_DEFAULT = 100;
    const GRID_ROWS = 4;
    const GRID_COLS = 5;
    const TOTAL_CELLS = GRID_ROWS * GRID_COLS;
    const SPIN_DURATION_MS = 2200;      // durasi total, semua berhenti bersamaan
    const COL_STAGGER_MS   = 160;       // jeda mulai antar kolom
    const CASCADE_DELAY_MS = 260;       // jeda antar cascade
    const MAX_CASCADE      = 8;         // batas keamanan loop pecah

    // Sound (pakai file kamu)
    const sfx = {
      spin:    new Audio('sound/spin.mp3'),
      drop:    new Audio('sound/drop.mp3'),
      scatter: new Audio('sound/scatter.mp3'),
      win:     new Audio('sound/win.mp3'),
    };
    Object.values(sfx).forEach(a=>{ a.preload='auto'; a.volume = 1.0; });

    // Simbol
    const SYMBOLS = [
      // Bamboo 1‚Äì9
      "bamboo-1","bamboo-2","bamboo-3","bamboo-4","bamboo-5","bamboo-6","bamboo-7","bamboo-8","bamboo-9",
      // Characters 1‚Äì9
      "characters-1","characters-2","characters-3","characters-4","characters-5","characters-6","characters-7","characters-8","characters-9",
      // Dots 1‚Äì9
      "dots-1","dots-2","dots-3","dots-4","dots-5","dots-6","dots-7","dots-8","dots-9",
      // Winds
      "wind-east","wind-south","wind-west","wind-north",
      // Dragons
      "dragon-red","dragon-green","dragon-white",
      // Special
      "wild","scatter"
    ];
    const TYPE = Object.fromEntries(SYMBOLS.map(k=>{
      let t='normal';
      if(k==='wild') t='wild';
      else if(k==='scatter') t='scatter';
      return [k,t];
    }));

    // Bobot kemunculan (wild & scatter lebih jarang)
    const WEIGHT = Object.fromEntries(SYMBOLS.map(k=>{
      if(k==='wild') return [k, 2];
      if(k==='scatter') return [k, 2];
      if(k.startsWith('wind') || k.startsWith('dragon')) return [k, 4];
      return [k, 8]; // suits lebih sering
    }));

    // Pembayaran ways (contoh)
    const PAY_TABLE = { 3:1, 4:3, 5:10 };
    // Scatter pay (wherever)
    const SCATTER_PAY = { 3:2, 4:10, 5:50 };
    const SCATTER_FREESPINS = 8;

    /**************
     * DOM & STATE
     **************/
    const slot = document.getElementById('slot');
    const spinBtn = document.getElementById('spinBtn');
    const saldoBox = document.getElementById('saldo').querySelector('b');
    const betBox = document.getElementById('bet').querySelector('b');
    const freeBox = document.getElementById('frees').querySelector('b');
    const statusBox = document.getElementById('status');

    let saldo = 10000;
    let bet = BET_DEFAULT;
    let freeSpins = 0;
    let isSpinning = false;
    let colIntervals = []; // interval per kolom (untuk animasi)

    // Helper: format Rupiah
    const fmtRp = n => 'Rp ' + n.toLocaleString('id-ID');

    function updateHUD(){
      saldoBox.textContent = fmtRp(saldo);
      betBox.textContent   = fmtRp(bet);
      freeBox.textContent  = freeSpins;
    }
    function status(msg){ statusBox.textContent = msg || ''; }
    const wait = (ms)=> new Promise(r=>setTimeout(r,ms));

    /*****************
     * UTIL RANDOM
     *****************/
    function pickWeighted(){
      const total = SYMBOLS.reduce((s,k)=>s+WEIGHT[k],0);
      let roll = Math.random()*total;
      for(const k of SYMBOLS){
        roll -= WEIGHT[k];
        if(roll<=0) return k;
      }
      return SYMBOLS[0];
    }

    function generateBoard(){
      const arr = new Array(TOTAL_CELLS);
      for(let i=0;i<TOTAL_CELLS;i++) arr[i] = pickWeighted();
      return arr;
    }

    /*****************
     * RENDER GRID
     *****************/
    function initGrid(){
      slot.innerHTML = '';
      for(let i=0;i<TOTAL_CELLS;i++){
        const wrap = document.createElement('div');
        wrap.className = 'tile-wrap';
        const img = document.createElement('img');
        img.alt = '';
        wrap.appendChild(img);
        slot.appendChild(wrap);
      }
      const first = generateBoard();
      drawBoard(first);
    }

    function drawBoard(board){
      const cells = slot.querySelectorAll('.tile-wrap');
      for(let i=0;i<TOTAL_CELLS;i++){
        const wrap = cells[i];
        const img  = wrap.querySelector('img');
        img.classList.remove('explode','drop','win-pop','spinning');
        img.src = 'img/tiles/' + board[i] + '.png';
        wrap.querySelector('.badge')?.remove();
        if(board[i]==='wild' || board[i]==='scatter'){
          const b = document.createElement('div');
          b.className='badge';
          b.textContent = (board[i]==='wild'?'WILD':'SC');
          wrap.appendChild(b);
        }
      }
    }

    /**************************
     * SPIN ANIMASI (KOLOM)
     **************************/
    function startColumnSpin(){
      const cells = slot.querySelectorAll('.tile-wrap img');
      colIntervals.forEach(id=>clearInterval(id));
      colIntervals = [];

      for(let c=0;c<GRID_COLS;c++){
        setTimeout(()=>{
          for(let r=0;r<GRID_ROWS;r++){
            const idx = r*GRID_COLS + c;
            cells[idx].classList.add('spinning');
          }
          const id = setInterval(()=>{
            for(let r=0;r<GRID_ROWS;r++){
              const idx = r*GRID_COLS + c;
              cells[idx].src = 'img/tiles/'+ pickWeighted() + '.png';
            }
          }, 70);
          colIntervals[c]=id;
        }, c*COL_STAGGER_MS);
      }
    }

    function stopAllColumnSpin(finalBoard){
      const cells = slot.querySelectorAll('.tile-wrap img');
      for(let c=0;c<GRID_COLS;c++){
        if(colIntervals[c]){ clearInterval(colIntervals[c]); }
        for(let r=0;r<GRID_ROWS;r++){
          const idx = r*GRID_COLS + c;
          cells[idx].classList.remove('spinning');
          cells[idx].src = 'img/tiles/' + finalBoard[idx] + '.png';
        }
      }
      colIntervals = [];
      const wraps = slot.querySelectorAll('.tile-wrap');
      wraps.forEach((w,i)=>{
        w.querySelector('.badge')?.remove();
        const key = finalBoard[i];
        if(key==='wild' || key==='scatter'){
          const b = document.createElement('div'); b.className='badge';
          b.textContent = (key==='wild'?'WILD':'SC');
          w.appendChild(b);
        }
      });
    }

    /*********************************
     * EVALUASI MENANG (WAYS 4√ó5)
     *********************************/
    function evaluateWins(board){
      const mark = new Array(TOTAL_CELLS).fill(false);
      let totalWinMult = 0;
      let scatterCount = 0;

      // Scatter count
      for(const k of board){ if(k==='scatter') scatterCount++; }
      let scatterPay = 0;
      if(scatterCount>=3){
        scatterPay = (SCATTER_PAY[scatterCount] ?? SCATTER_PAY[3]) * bet;
      }

      // Hanya simbol normal untuk pembacaan garis
      const baseSymbols = SYMBOLS.filter(k=>TYPE[k]==='normal');

      for(const sym of baseSymbols){
        // indeks cocok per kolom
        const colMatches = [];
        for(let c=0;c<GRID_COLS;c++){
          const indices = [];
          for(let r=0;r<GRID_ROWS;r++){
            const idx = r*GRID_COLS + c;
            const k = board[idx];
            if(k===sym || k==='wild'){
              indices.push(idx);
            }
          }
          colMatches[c] = indices;
        }

        // cari run kolom berturut (>=3)
        let maxLen = 0, currentRun = [], runs = [];
        for(let c=0;c<GRID_COLS;c++){
          if(colMatches[c].length>0) currentRun.push(c);
          else{
            if(currentRun.length>=3) runs.push([...currentRun]);
            maxLen = Math.max(maxLen, currentRun.length);
            currentRun = [];
          }
        }
        if(currentRun.length>=3) runs.push([...currentRun]);
        maxLen = Math.max(maxLen, currentRun.length);
        if(maxLen<3) continue;

        // hitung ways dan tandai pecah
        let symbolWinMult = 0;
        for(const run of runs){
          const len = run.length;
          const mult = PAY_TABLE[len] ?? 0;
          if(mult<=0) continue;

          let ways = 1;
          for(const c of run){
            ways *= Math.max(1, colMatches[c].length);
          }
          // tandai semua match pada kolom2 run (efek "pecah 8 gambar sama" dst)
          for(const c of run){
            for(const idx of colMatches[c]){
              mark[idx] = true;
            }
          }
          symbolWinMult += mult * ways;
        }
        totalWinMult += symbolWinMult;
      }

      const totalLineWin = totalWinMult * bet;
      return {
        scatterCount,
        scatterPay,
        linePay: totalLineWin,
        totalPay: totalLineWin + scatterPay,
        mark
      };
    }

    /********************
     * CASCADE (pecah)
     ********************/
    function explodeAndCascade(board, mark){
      return new Promise(async (resolve)=>{
        const imgs  = slot.querySelectorAll('.tile-wrap img');

        // animasi pop
        mark.forEach((m,i)=>{ if(m) imgs[i].classList.add('win-pop'); });
        await wait(120);

        // explode
        mark.forEach((m,i)=>{ if(m) imgs[i].classList.add('explode'); });
        sfx.win.currentTime = 0; sfx.win.play().catch(()=>{});
        await wait(260);

        // Cascade per kolom
        for(let c=0;c<GRID_COLS;c++){
          let col = [];
          for(let r=0;r<GRID_ROWS;r++){
            const idx = r*GRID_COLS + c;
            if(!mark[idx]) col.push(board[idx]);
          }
          const missing = GRID_ROWS - col.length;
          for(let k=0;k<missing;k++) col.unshift(pickWeighted());
          for(let r=0;r<GRID_ROWS;r++){
            const idx = r*GRID_COLS + c;
            board[idx] = col[r];
          }
        }

        // render + drop
        drawBoard(board);
        const imgs2 = slot.querySelectorAll('.tile-wrap img');
        imgs2.forEach(img => img.classList.add('drop'));
        sfx.drop.currentTime=0; sfx.drop.play().catch(()=>{});
        await wait(220);

        resolve(board);
      });
    }

    /*****************
     * SPIN ALUR UTAMA
     *****************/
    async function doSpin(){
      if(isSpinning) return;
      if(freeSpins<=0 && saldo < bet){ status('Saldo tidak cukup!'); return; }

      isSpinning = true;
      spinBtn.disabled = true;
      status('Berputar‚Ä¶');

      // Potong saldo kalau bukan free spin
      if(freeSpins>0){ freeSpins--; }
      else{ saldo -= bet; }
      updateHUD();

      // SFX spin
      sfx.spin.currentTime=0; sfx.spin.play().catch(()=>{});

      // Mulai animasi kolom (stagger), namun stop bersama
      startColumnSpin();

      // Tentukan hasil akhir
      let board = generateBoard();

      // Stop bersama setelah durasi
      await wait(SPIN_DURATION_MS);
      stopAllColumnSpin(board);

      // Evaluasi + cascade
      let totalWin = 0;
      let scatterAwarded = 0;

      for(let step=0; step<MAX_CASCADE; step++){
        const res = evaluateWins(board);

        // Scatter hanya diproses di langkah pertama (seperti kebanyakan slot)
        if(step===0 && res.scatterCount>=3){
          sfx.scatter.currentTime=0; sfx.scatter.play().catch(()=>{});
          freeSpins += SCATTER_FREESPINS;
          scatterAwarded = SCATTER_FREESPINS;
        }

        // Jika tidak ada kemenangan sama sekali, break
        if(res.totalPay<=0 || !res.mark.some(Boolean)){
          if(step===0){
            status('Tidak ada kemenangan.');
          }else{
            status(`Selesai cascade: Menang total ${fmtRp(totalWin)}.`);
          }
          break;
        }

        totalWin += res.totalPay;
        status(`Menang ${fmtRp(res.totalPay)} (step ${step+1}).`);
        await explodeAndCascade(board, res.mark);
        await wait(CASCADE_DELAY_MS);
      }

      // Tambah saldo bila ada win
      if(totalWin>0){
        saldo += totalWin;
      }
      updateHUD();

      // Info akhir putaran
      let tail = [];
      if(totalWin>0) tail.push(`Win: ${fmtRp(totalWin)}`);
      if(scatterAwarded>0) tail.push(`+${scatterAwarded} Free Spins`);
      if(freeSpins>0) tail.push(`FS tersisa: ${freeSpins}`);
      status(tail.join(' ‚Ä¢ ') || '‚Äî');

      isSpinning = false;
      spinBtn.disabled = false;
    }

    /**************
     * BOOTSTRAP
     **************/
    spinBtn.addEventListener('click', doSpin);
    initGrid();
    updateHUD();
    status('Siap. Tekan SPIN!');
  </script>
</body>
</html>
