<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>üÄÑ Slot Mahjong ‚Äì Mobile</title>
<style>
  :root{
    --bg:#0b1020; --panel:#121a33; --card:#0f1530; --muted:#93a4c8; --text:#eaf2ff;
    --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --line:#38bdf8;
    --tile:#0b153a; --tile2:#0f1f4f; --shadow:0 10px 20px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box}
  body{
    margin:0; background:radial-gradient(1200px 800px at 70% -10%,#1a2550 0%,#0b1020 60%);
    color:var(--text); font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;
    min-height:100vh; display:flex; flex-direction:column; gap:8px;
  }
  header{
    padding:10px 12px; background:rgba(10,16,35,.65); backdrop-filter:saturate(1.2) blur(6px);
    display:flex; gap:8px; justify-content:space-between; align-items:center; border-bottom:1px solid #223155;
  }
  h1{margin:0;font-size:16px;display:flex;gap:8px;align-items:center}
  .brand{display:flex;align-items:center;gap:6px}
  .row{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  .btn{
    border:0; border-radius:12px; padding:9px 14px; font-weight:700; cursor:pointer;
    color:#062314; background:var(--accent); box-shadow:var(--shadow); transition:.15s transform;
  }
  .btn:active{transform:translateY(1px)}
  .btn.secondary{background:#334155;color:#e5edf7}
  .btn.warn{background:var(--warn);color:#2a1904}
  .btn.danger{background:var(--danger);color:#2b0b0b}
  .btn[disabled]{opacity:.45;pointer-events:none}
  .wrap{padding:10px; display:grid; gap:10px}
  .board{
    background:linear-gradient(180deg,#0e1636 0%, #0b1230 100%);
    border-radius:16px; padding:10px; box-shadow:var(--shadow);
    border:1px solid #1e2b59;
  }
  /* Reels */
  .stage{
    --cols:5; --rows:3;
    width:100%; aspect-ratio:5/3; position:relative; overflow:hidden; border-radius:14px;
    background:linear-gradient(180deg,#0b1435,#09102a);
  }
  .reels{display:grid; grid-template-columns:repeat(var(--cols),1fr); height:100%; gap:8px; padding:8px}
  .reel{position:relative; overflow:hidden; border-radius:10px; background:linear-gradient(180deg,var(--tile),var(--tile2))}
  .strip{position:absolute; left:0; right:0; top:0; will-change:transform; filter:drop-shadow(0 2px 0 #09132f)}
  .cell{
    height:calc((100% - 16px)/3); display:flex; align-items:center; justify-content:center;
    font-size:clamp(26px,6.5vw,48px);
  }
  .blur .strip{filter:blur(2px) brightness(1.2)}
  /* Payline highlight */
  .lineCanvas{position:absolute; inset:0; pointer-events:none}
  /* Panel bawah */
  .hud{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .kbd{background:#0b1433;border:1px solid #1c2a5c;border-radius:6px;padding:3px 6px;font-family:ui-monospace,Consolas,monospace;color:#cfe1ff}
  .card{background:var(--panel); border-radius:16px; padding:10px; box-shadow:var(--shadow); border:1px solid #1e2b59}
  details summary{cursor:pointer; user-select:none}
  textarea{width:100%; min-height:120px; background:#07112a; color:#dce9ff; border:1px solid #1b2b59; border-radius:10px; padding:8px; font:12px/1.4 ui-monospace,Consolas,monospace}
  .grow{flex:1}
  @media (min-width:900px){
    .wrap{grid-template-columns: 1.2fr .8fr}
  }
</style>
</head>
<body>
  <header>
    <div class="brand"><span style="font-size:18px">üÄÑ</span><h1>Slot Mahjong</h1></div>
    <div class="row">
      <button id="btnSpin" class="btn">üé∞ Spin</button>
      <button id="btnAuto" class="btn secondary">‚ñ∂ Auto</button>
      <button id="btnStop" class="btn danger" disabled>‚èπ Stop</button>
    </div>
  </header>

  <div class="wrap">
    <section class="board card">
      <div class="stage" id="stage">
        <div class="reels" id="reels"></div>
        <canvas class="lineCanvas" id="lines"></canvas>
      </div>
      <div class="hud">
        <span>Saldo: <span id="bal" class="kbd">10000</span></span>
        <span>Taruhan:
          <button id="betMinus" class="btn secondary" style="padding:4px 8px">‚àí</button>
          <span id="bet" class="kbd">100</span>
          <button id="betPlus" class="btn secondary" style="padding:4px 8px">Ôºã</button>
        </span>
        <span>Menang: <span id="win" class="kbd">0</span></span>
        <span class="grow"></span>
        <label class="row"><input id="sfx" type="checkbox" checked> SFX</label>
      </div>
    </section>

    <section class="card">
      <details>
        <summary>Log</summary>
        <pre id="log" style="max-height:180px;overflow:auto;background:#0b1433;border-radius:10px;padding:8px"></pre>
      </details>
      <details>
        <summary>Opsional: Tempel Script Asli (tidak wajib)</summary>
        <textarea id="original"></textarea>
        <div class="row" style="margin-top:6px">
          <button id="runOriginal" class="btn warn">‚öô Jalankan Script Asli</button>
          <span>Status: <span id="execStatus" class="kbd">idle</span></span>
        </div>
      </details>
      <div class="label" style="color:var(--muted);margin-top:8px">Paylines: 10 | 5√ó3 | Pembayaran: 3/4/5 berturut dari kiri.</div>
    </section>
  </div>

<script>
/* ========= Utility ========= */
const $=q=>document.querySelector(q);
const log=(...a)=>{$("#log").textContent+=a.join(" ")+"\\n";$("#log").scrollTop=$("#log").scrollHeight;}
const rng=()=>Math.random();

/* ========= Konfigurasi Game ========= */
const COLS=5, ROWS=3;
const SYMBOLS=[
  {id:'RD', ch:'üÄÑ', weight:2,  pay:[0,0,50,200,1000]}, // Red Dragon (rare)
  {id:'GR', ch:'üÄô', weight:3,  pay:[0,0,40,160,600]},  // Green dragon substitute-ish (no wild, cuma bayar tinggi)
  {id:'1',  ch:'üÄá', weight:6,  pay:[0,0,20,80,300]},
  {id:'2',  ch:'üÄà', weight:7,  pay:[0,0,16,60,200]},
  {id:'3',  ch:'üÄâ', weight:8,  pay:[0,0,12,40,160]},
  {id:'4',  ch:'üÄä', weight:9,  pay:[0,0,10,30,120]},
  {id:'5',  ch:'üÄã', weight:10, pay:[0,0,8, 24,90]},
  {id:'6',  ch:'üÄå', weight:12, pay:[0,0,6, 18,70]},
  {id:'7',  ch:'üÄç', weight:12, pay:[0,0,5, 15,60]},
  {id:'8',  ch:'üÄé', weight:12, pay:[0,0,4, 12,50]},
];
const STRIP = SYMBOLS.flatMap(s=>Array(s.weight).fill(s.id)); // weighted strip

// 10 paylines (dari kiri ‚Üí kanan), koordinat per kolom (row index 0..2)
const PAYLINES = [
  [1,1,1,1,1], // tengah
  [0,0,0,0,0], // atas
  [2,2,2,2,2], // bawah
  [0,1,2,1,0],
  [2,1,0,1,2],
  [0,0,1,0,0],
  [2,2,1,2,2],
  [1,0,1,2,1],
  [1,2,1,0,1],
  [0,1,1,1,2],
];

const SYM = Object.fromEntries(SYMBOLS.map(s=>[s.id,s]));

/* ========= DOM Reels ========= */
const reelsEl = $("#reels");
const linesCanvas = $("#lines");
function setupReels(){
  reelsEl.innerHTML='';
  for(let c=0;c<COLS;c++){
    const col=document.createElement('div'); col.className='reel';
    const strip=document.createElement('div'); strip.className='strip';
    // 3 sel awal (akan diganti ketika berhenti)
    for(let r=0;r<ROWS;r++){
      const cell=document.createElement('div'); cell.className='cell'; cell.textContent='?';
      strip.appendChild(cell);
    }
    col.appendChild(strip);
    reelsEl.appendChild(col);
  }
  resizeLines();
}
function resizeLines(){
  const rect = $("#stage").getBoundingClientRect();
  linesCanvas.width=rect.width*2; linesCanvas.height=rect.height*2;
  linesCanvas.style.width=rect.width+'px'; linesCanvas.style.height=rect.height+'px';
}
window.addEventListener('resize', resizeLines);

/* ========= Engine ========= */
function pickSymbol(){ return STRIP[(STRIP.length*rng())|0]; }
function spinResult(){
  // kembalikan matriks [col][row] id symbol
  const grid = Array.from({length:COLS}, ()=>Array.from({length:ROWS}, ()=>pickSymbol()));
  return grid;
}
// evaluasi 10 paylines, left-to-right contiguous
function evaluate(grid, bet){
  const wins=[];
  for (let li=0; li<PAYLINES.length; li++){
    const line=PAYLINES[li];
    const first=grid[0][ line[0] ];
    let count=1;
    for(let c=1;c<COLS;c++){
      const sym = grid[c][ line[c] ];
      if(sym===first) count++; else break;
    }
    if(count>=3){
      const pay = SYM[first].pay[count] * (bet/100);
      if(pay>0) wins.push({line:li,count,symbol:first,amount:pay});
    }
  }
  const total=wins.reduce((a,w)=>a+w.amount,0);
  return {wins,total};
}

/* ========= Animasi & Render ========= */
let spinning=false, autoTimer=null;
let balance=10000, bet=100, lastWin=0;

function updateHUD(){
  $("#bal").textContent = balance.toFixed(0);
  $("#bet").textContent = bet.toFixed(0);
  $("#win").textContent = lastWin.toFixed(0);
}
function setButtonsBusy(busy){
  $("#btnSpin").disabled = busy;
  $("#btnAuto").disabled = busy || autoTimer!=null;
  $("#btnStop").disabled = !busy && autoTimer==null ? true:false;
}

function drawLines(wins){
  const ctx=linesCanvas.getContext('2d');
  ctx.clearRect(0,0,linesCanvas.width,linesCanvas.height);
  if(!wins?.length) return;
  const rect = $("#stage").getBoundingClientRect();
  const cw = rect.width / COLS, ch = rect.height / ROWS;
  ctx.lineWidth=4*2; ctx.strokeStyle='#38bdf8aa'; ctx.lineJoin='round';
  wins.forEach(w=>{
    const path=PAYLINES[w.line];
    ctx.beginPath();
    for(let c=0;c<COLS;c++){
      const x=(c*cw + cw/2)*2;
      const y=(path[c]*ch + ch/2)*2;
      if(c===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  });
}

async function spin(){
  if(spinning) return;
  if(balance<bet){ log('Saldo tidak cukup'); return; }
  spinning=true; lastWin=0; setButtonsBusy(true);
  balance-=bet; updateHUD(); drawLines([]);

  // target hasil
  const result=spinResult();

  // jalankan animasi tiap reel berurutan
  const cols=[...reelsEl.children];
  for(let c=0;c<COLS;c++){
    const reel=cols[c];
    reel.classList.add('blur');
    const strip=reel.querySelector('.strip');

    // buat 12 item acak untuk animasi bergulir
    strip.innerHTML='';
    const cycle=12;
    for(let i=0;i<cycle;i++){
      const cell=document.createElement('div'); cell.className='cell';
      const id=pickSymbol(); cell.textContent=SYM[id].ch;
      strip.appendChild(cell);
    }
    // mulai dari -offset lalu transisi ke posisi akhir
    const step = strip.children[0].getBoundingClientRect().height;
    strip.style.transition='none';
    strip.style.transform=`translateY(-${step* (cycle-ROWS)}px)`;
    await wait(10);

    // gulir cepat
    strip.style.transition='transform 600ms cubic-bezier(.2,.7,0,1)';
    strip.style.transform='translateY(0px)';
    await wait(600 + c*90);

    // pasang 3 symbol final
    strip.style.transition='none';
    strip.innerHTML='';
    for(let r=0;r<ROWS;r++){
      const cell=document.createElement('div'); cell.className='cell';
      const id=result[c][r]; cell.textContent=SYM[id].ch;
      strip.appendChild(cell);
    }
    reel.classList.remove('blur');
    // kecilkan delay antar reel agar berurutan
    await wait(90);
  }

  const payout=evaluate(result,bet);
  balance+=payout.total; lastWin=payout.total; updateHUD();
  if(payout.total>0) {
    drawLines(payout.wins);
    sfxWin();
    log(`Menang ${payout.total} pada ${payout.wins.length} line: `+
      payout.wins.map(w=>`${SYM[w.symbol].ch} x${w.count}`).join(', '));
  } else {
    log('Tidak menang');
  }
  spinning=false; setButtonsBusy(false);
  if(autoTimer && balance>=bet){ /* terus */ }
  else if(autoTimer){ stopAuto(); }
}

function wait(ms){return new Promise(r=>setTimeout(r,ms));}

/* ========= Audio sederhana ========= */
let ctxA=null, beepOsc=null;
function sfx(beats=[440,660,880], dur=70){
  if(!$("#sfx").checked) return;
  if(!ctxA) ctxA = new (window.AudioContext||window.webkitAudioContext)();
  const now=ctxA.currentTime;
  beats.forEach((f,i)=>{
    const o=ctxA.createOscillator(), g=ctxA.createGain();
    o.frequency.value=f; o.type='sine';
    g.gain.value=0.0001; g.gain.setTargetAtTime(0.15,now+i*0.08,0.01);
    g.gain.setTargetAtTime(0.0001,now+i*0.08+dur/1000,0.05);
    o.connect(g).connect(ctxA.destination); o.start(now+i*0.08); o.stop(now+i*0.08+0.35);
  });
}
const sfxClick=()=>sfx([220,330],50);
const sfxWin=()=>sfx([740,880,1040,1320],65);

/* ========= Kontrol ========= */
function startAuto(){
  if(autoTimer || spinning) return;
  $("#btnAuto").disabled=true; $("#btnStop").disabled=false;
  autoTimer = setInterval(()=>{ if(!spinning) spin(); }, 100);
}
function stopAuto(){
  clearInterval(autoTimer); autoTimer=null;
  $("#btnAuto").disabled=false; $("#btnStop").disabled=true;
}
$("#btnSpin").onclick=()=>{ sfxClick(); spin(); };
$("#btnAuto").onclick=()=>{ sfxClick(); startAuto(); };
$("#btnStop").onclick=()=>{ sfxClick(); stopAuto(); };
$("#betMinus").onclick=()=>{ bet=Math.max(100, bet-100); updateHUD(); sfxClick(); };
$("#betPlus").onclick=()=>{ bet=Math.min(5000, bet+100); updateHUD(); sfxClick(); };

/* ========= Opsional: jalankan script asli (sandboxed) ========= */
$("#runOriginal").onclick=()=>{
  try{
    const code=$("#original").value;
    if(!code.trim()){ $("#execStatus").textContent='kosong'; return; }
    // dijalankan terisolasi (Function sandbox, tanpa arg)
    new Function('"use strict";\\n'+code)();
    $("#execStatus").textContent='OK';
    log('Script asli dijalankan.');
  }catch(e){
    $("#execStatus").textContent='gagal';
    log('Error script asli:', e.message);
  }
};

/* ========= Inisialisasi ========= */
function init(){
  setupReels(); resizeLines(); updateHUD(); drawLines([]);
}
document.addEventListener('visibilitychange',()=>{ if(document.hidden && autoTimer) stopAuto(); });
init();
</script>
</body>
</html>
